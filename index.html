<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro por Voz con Base de Datos</title>
  <style>
  body {
    font-family: sans-serif;
    padding: 10px;
    margin: 0;
    background: #fff;
  }
  .registro {
    background: #f1f1f1;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    position: relative;
    font-size: 14px;
    word-wrap: break-word;
  }
  .botones {
    margin-top: 5px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }
  button {
    margin-right: 5px;
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 5px;
    border: none;
    background-color: #007bff;
    color: white;
  }
  button:hover {
    background-color: #0056b3;
  }
  .active {
    color: green;
    font-weight: bold;
  }
  #json-actual {
    white-space: pre-wrap;
    background: #e6f7ff;
    padding: 10px;
    border: 1px solid #b3d9ff;
    margin-top: 20px;
    border-radius: 6px;
    font-size: 14px;
    overflow-wrap: break-word;
  }
  @media screen and (max-width: 600px) {
    body {
      padding: 8px;
    }
    button {
      width: 100%;
      margin-bottom: 8px;
    }
    .registro {
      font-size: 13px;
    }
  }
</style>
</head>
<body>
  <h2>üéôÔ∏è Registro de Actividades por Voz</h2>
  <button id="start-btn">Iniciar Reconocimiento</button>
  <div id="status"></div>
  <h3>üì¶ Registro actual en curso:</h3>
  <pre id="json-actual" contenteditable="true"></pre>
  <h3>üìö Registros guardados:</h3>
<button onclick="exportarJSON()">Exportar a JSON</button>
<button onclick="exportarCSV()">Exportar a CSV</button>
<button onclick="reiniciarBaseDatos()">üóëÔ∏è Reiniciar Base de Datos</button>
  <div id="registros"></div>

  <script>
    const dbName = "RegistrosVozDB";
    let db;

    const request = indexedDB.open(dbName, 1);
    request.onupgradeneeded = function(event) {
      db = event.target.result;
      db.createObjectStore("registros", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = function(event) {
      db = event.target.result;
      cargarRegistros();
    };

    function guardarRegistro(data) {
      const tx = db.transaction("registros", "readwrite");
      const store = tx.objectStore("registros");
      store.add(data);
      tx.oncomplete = cargarRegistros;
    }

    function eliminarRegistro(id) {
      const tx = db.transaction("registros", "readwrite");
      const store = tx.objectStore("registros");
      store.delete(id);
      tx.oncomplete = cargarRegistros;
    }

    function cargarRegistros() {
      const tx = db.transaction("registros", "readonly");
      const store = tx.objectStore("registros");
      const req = store.getAll();
      req.onsuccess = function() {
        const cont = document.getElementById("registros");
        cont.innerHTML = "";
        req.result.forEach(item => {
          const div = document.createElement("div");
          div.className = "registro";
          div.innerHTML = `<pre contenteditable="true">${JSON.stringify(item, null, 2)}</pre>
            <div class="botones">
              <button onclick="editarRegistro(${item.id})">Editar</button>
              <button onclick="eliminarRegistro(${item.id})">Eliminar</button>
            </div>`;
          cont.appendChild(div);
        });
      };
    }

    function editarRegistro(id) {
  const registros = document.querySelectorAll(".registro");
  registros.forEach(div => {
    const pre = div.querySelector("pre[contenteditable]");
    if (pre && div.innerHTML.includes(`editarRegistro(${id})`)) {
      try {
        const nuevoData = JSON.parse(pre.innerText);
        nuevoData.id = id;
        const tx = db.transaction("registros", "readwrite");
        const store = tx.objectStore("registros");
        store.put(nuevoData);
        tx.oncomplete = cargarRegistros;
      } catch (e) {
        alert("JSON inv√°lido: " + e.message);
      }
    }
  });
}

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = true;
    recognition.interimResults = false;

    let startTime = null;
    let endTime = null;
    let tiempoFinalizado = false;
    let data = crearNuevoRegistro();

    function crearNuevoRegistro() {
      return {
        fecha: new Date().toISOString().split("T")[0],
        trabajador: "Anderson Perez",
        actividad: "",
        unidad: "",
        cantidad: null,
        inicio: null,
        fin: null,
        duracion: null,
        observaciones: "",
        estado: "en proceso"
      };
    }

    function actualizarVistaActual() {
  const elem = document.getElementById("json-actual");
  elem.textContent = JSON.stringify(data, null, 2);
}

    document.getElementById('start-btn').onclick = () => {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
    recognition.start();
    document.getElementById('status').innerHTML = 'üéß <span class="active">Escuchando...</span>';
  }).catch(err => {
    alert("Permiso de micr√≥fono denegado: " + err.message);
  });
};

    recognition.onresult = function(event) {
      const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
      console.log("üé§ Reconocido:", transcript);

      if (transcript.includes("inicio") && !startTime) {
        startTime = new Date();
        data.inicio = startTime.toLocaleTimeString();
      }

      if (transcript.includes("fin") && startTime && !endTime) {
        endTime = new Date();
        data.fin = endTime.toLocaleTimeString();
        const seconds = Math.round((endTime - startTime) / 1000);
        data.duracion = `${seconds} segundos`;
        data.estado = "esperando observaciones";
        tiempoFinalizado = true;
      }

      const cantidadUnidadMatch = transcript.match(/(cantidad\s+)?((\d+([.,]\d+)?)|un|uno|una)?\s*(cent√≠metros|centimetros|metros|pulgadas|cm|m|unidad)/);
      if (cantidadUnidadMatch) {
        let cantidadTexto = cantidadUnidadMatch[2];
        let unidadTexto = cantidadUnidadMatch[5];
        if (unidadTexto) data.unidad = unidadTexto;
        if (!cantidadTexto || ["un", "uno", "una"].includes(cantidadTexto)) {
          data.cantidad = 1;
        } else {
          data.cantidad = parseFloat(cantidadTexto.replace(",", "."));
        }
        if (unidadTexto === "unidad" && data.cantidad === null) {
          data.cantidad = 1;
        }
      }

      const actividades = [
        "soldadura", "corte", "pulido", "reja", "ensamble", "pintado", "lijado", 
        "soldadura mig", "soldadura tig", "pintura", "perforado", "doblado", "reparaci√≥n"
      ];
      actividades.forEach(act => {
        if (transcript.includes(act)) data.actividad = act;
      });

      const observacionMatch = transcript.match(/observaci[o√≥]n(?:es)?\s*[:\-]?\s*(.*)/);
      if (observacionMatch && observacionMatch[1]) {
        data.observaciones += (data.observaciones ? "\n" : "") + observacionMatch[1].trim();
      }

      if (transcript.includes("siguiente") && tiempoFinalizado) {
        data.estado = "terminado";
        guardarRegistro(data);
        data = crearNuevoRegistro();
        startTime = null;
        endTime = null;
        tiempoFinalizado = false;
      }

      actualizarVistaActual();
    };

    recognition.onerror = function(event) {
      console.error("‚ùå Error en reconocimiento:", event.error);
    };
  function exportarJSON() {
  const tx = db.transaction("registros", "readonly");
  const store = tx.objectStore("registros");
  const req = store.getAll();

  req.onsuccess = function () {
    const data = req.result;
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "registros.json";
    a.click();
    URL.revokeObjectURL(url);
  };
}

function exportarCSV() {
  const tx = db.transaction("registros", "readonly");
  const store = tx.objectStore("registros");
  const req = store.getAll();

  req.onsuccess = function () {
    const data = req.result;
    if (!data.length) return;

    const headers = Object.keys(data[0]);
    const rows = data.map(obj => headers.map(key => JSON.stringify(obj[key] ?? "")));
    const csv = [headers.join(","), ...rows.map(row => row.join(","))].join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "registros.csv";
    a.click();
    URL.revokeObjectURL(url);
  };
}

function reiniciarBaseDatos() {
  const confirmacion = confirm("¬øEst√°s seguro de que quieres borrar todos los registros?");
  if (!confirmacion) return;
  indexedDB.deleteDatabase("RegistrosVozDB");
  alert("Base de datos eliminada. Recarga la p√°gina para comenzar de nuevo.");
}
</script>
</body>
</html>
